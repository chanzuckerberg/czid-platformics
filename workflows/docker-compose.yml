version: '3.8'

x-aws-variables: &aws-variables
  ? AWS_ACCESS_KEY_ID=123
  ? AWS_SECRET_ACCESS_KEY=123
  ? AWS_SESSION_TOKEN=123
  ? AWS_REGION=us-east-1
  ? AWS_DEFAULT_REGION=us-east-1

x-db-variables: &db-variables
  ? PLATFORMICS_DATABASE_HOST=postgres.czidnet
  ? PLATFORMICS_DATABASE_PORT=5432
  ? PLATFORMICS_DATABASE_USER=postgres
  ? PLATFORMICS_DATABASE_PASSWORD=password_postgres
  ? PLATFORMICS_DATABASE_NAME=workflows

x-webservice-variables: &webservice-variables
  ? WORKERS=2

x-redis-variables: &redis-variables
  ? PLATFORMICS_EVENT_BUS__REDIS__REDIS_URL=redis://redis.czidnet:6378
  ? PLATFORMICS_EVENT_BUS__REDIS__QUEUE_NAME=workflow-events
  
x-workflow-variables: &workflow-variables
  ? ENVIRONMENT
  ? BOTO_ENDPOINT_URL=http://motoserver.czidnet:4000
  ? ENTITY_SERVICE_URL=http://entities.czidnet:8008
  ? DEFAULT_UPLOAD_BUCKET=local-bucket
  ? ENTITY_SERVICE_AUTH_TOKEN=eyJhbGciOiJFQ0RILUVTIiwiZW5jIjoiQTI1NkNCQy1IUzUxMiIsImVwayI6eyJjcnYiOiJQLTM4NCIsImt0eSI6IkVDIiwieCI6IlEtSjNEODgzVFJSTnpIWEw4dEJXNjlKc2owRnBLdXJnaGpHWjNQUXhMNFVkMWgxVExIWS0yUWdaMGczMFJzaHIiLCJ5IjoiQjV0cWtOdUpoS0IwWkY4Z3V5NjhNZERScjRjTzBZNW1VYTlxTXREMmF1QmZVbk9LbkxhQlZUVGhsY1B3WlFYRyJ9LCJraWQiOiItQmx2bF9wVk5LU2JRQ2N5dGV4UzNfMk5MaHBia2J6LVk5VFFjbkY5S1drIiwidHlwIjoiSldFIn0..OgC2LVAUbjvvN_Uy07HntA.DXUda7kJ6_HCRaPizYIM39z4flgOc1iSVgHB8zbKP-kYqXP4Pn8Xcd9d2C7jx0UdcEt9TmWWkAAHkOzNHo9A8d7j493xMvU03tga7R9HoRN35Rq0zQxQ00il8GIW0kXD9ujCgT_vThgcouOaLVJHEzQHMdeCh92A_TbExlbWueVA1ZlRNl_59CBSF7zXGCbuiI0t_UaeHpPF1vkKTYHBF5YuclxWqqym_Mm3WUsAgMBcn2Kpgnkvob6ZP7EamFrRfofQyruK8o-AlA5hebHzkYCKXpqltv3w6LG18x3l6ounacVJhXyq0MjrC0g-XG6hIC_u-EePuMgx2IYmyWOFX8EMqNajp3RdHMvF-s-vZ91uTlYoYYMBptAHHyQxSyrZyA4YR6_NjvclSBAYsX8V0xr8bsYFSY9dh1AqrJEDdlEm-ml1pjZtuLiTQzA1TtflmpUNI4uFmEm3qkME1f5sIi2QholembuQm6MhIVolIsmYVY_vW-iZm2_vW6EsQE5OzK-6NPUA7HH-Ex1_JcZ5SNrUnnAfXhBeMyUC6LmDpUUN0n4qj_a6xQa1DXZqCZc7.g5wdMu50vyHJIxmiFyNG1uQQFb0xE7rs98hQdxCuIAA
  ? DEFAULT_UPLOAD_PROTOCOL=S3 # don't need this in workflows
  ? PLATFORMICS_EVENT_BUS_PLUGIN=swipe
  ? PLATFORMICS_EVENT_BUS__SWIPE__SQS_QUEUE_URL=http://motoserver.czidnet:4000/123456789012/swipe-test-notifications-sfn-notifications-queue
  ? PLATFORMICS_EVENT_BUS__SWIPE__SQS_ENDPOINT=http://motoserver.czidnet:4000
  ? PLATFORMICS_WORKFLOW_RUNNER_PLUGIN=swipe
  ? PLATFORMICS_WORKFLOW_RUNNER__LOCAL__S3_ENDPOINT=http://motoserver.czidnet:4000
  ? PLATFORMICS_WORKFLOW_RUNNER__SWIPE__OUTPUT_S3_PREFIX=s3://local-bucket/nextgen/
  ? PLATFORMICS_WORKFLOW_RUNNER__SWIPE__STATE_MACHINE_ARN=arn:aws:states:us-east-1:123456789012:stateMachine:swipe-test-default-wdl
  ? PLATFORMICS_WORKFLOW_RUNNER__SWIPE__SFN_ENDPOINT=http://stepfunctions.czidnet:8083

x-cerbos-variables: &cerbos-variables
  ? CERBOS_URL=http://wf-cerbos:3592
  ? JWK_PUBLIC_KEY_FILE=/workflows/test_infra/fixtures/public_key.pem
  ? JWK_PRIVATE_KEY_FILE=/workflows/test_infra/fixtures/private_key.pem

services:
  redis:
    image: redis:7
    ports:
      - "6378:6378"
    command: ["redis-server", "--port", "6378"]
  postgres:
    image: postgres:15
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password_postgres
      - POSTGRES_DB=workflows
      # The postgres image declares a mounted volume at /var/lib/postgresql/data
      # by default, which means that the data in that directory is difficult to
      # snapshot and export. Here, we're telling Postgres to use this (non-mounted)
      # directory as its storage location instead so it works with our db snapshot
      # workflow.
      - PGDATA=/var/lib/platformics/data
  workflows:
    build:
      context: ".."
      dockerfile: "workflows/Dockerfile"
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: "platformics-workflows"
    restart: always
    volumes:
      - .:/workflows
      # mount /tmp for local runner which uses miniwdl
      - /tmp:/tmp
      # enable docker in docker
      - /var/run/docker.sock:/var/run/docker.sock
      - ../platformics:/workflows/platformics
    ports:
      - 8042:8042
    stdin_open: true # Helps with pdb
    tty: true # Helps with pdb
    environment:
      <<: [*aws-variables, *db-variables, *redis-variables, *workflow-variables, *cerbos-variables, *webservice-variables]
  workflows-worker:
    build:
      context: ".."
      dockerfile: "workflows/Dockerfile"
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: "platformics-workflows"
    command: ["python3", "api/loader/run_loader.py"]
    restart: always
    volumes:
      - .:/workflows
    stdin_open: true # Helps with pdb
    tty: true # Helps with pdb
    environment:
      <<: [*aws-variables, *db-variables, *redis-variables, *workflow-variables, *cerbos-variables]
  wf-cerbos:
    image: ghcr.io/cerbos/cerbos:0.29.0
    volumes:
      - ./cerbos:/workflows
    command:
      ["server", "--config", "/workflows/config/config.yaml"]
networks:
  default:
    name: czidnet
    driver: overlay
    attachable: true
    external: true

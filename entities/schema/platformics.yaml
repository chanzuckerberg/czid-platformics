id: https://czid.org/entities/schema/platformics
title: CZID Platformics Bio-Entities Schema
name: platformics
default_range: string

types:
  string:
    uri: xsd:string
    base: str
    description: A character string

  integer:
    uri: xsd:integer
    base: int
    description: An integer

  uuid:
    uri: xsd:string
    typeof: str
    base: str
    description: A UUID

enums:
  FileStatus:
    permissible_values:
      SUCCESS:
        description: This file has been uploaded and validated successfully
      FAILED:
        description: This file failed to upload or failed validation
      PENDING:
        description: This file is a placeholder and awaiting a successful upload
  FileAcessProtocol:
    permissible_values:
      s3:
        description: This file is accessible via the (AWS) S3 protocol
  NucleicAcid:
    permissible_values:
      RNA:
      DNA:
  SequencingProtocol:
    permissible_values:
      MNGS:
        description: Metagenomics Sequencing
      TARGETED:
        description: Targeted Squencing (amplified via primers)
      MSSPE:
        description: MSSPE Sequencing
  SequencingTechnology:
    permissible_values:
      Illumina:
      Nanopore:
  AlignmentTool:
    permissible_values:
      bowtie2:
      minimap2:
      ncbi:
  TaxonLevel:
    permissible_values:
      species:
      genus:
      family:

classes:
  Entity:
    attributes:
      id:
        identifier: true
        range: uuid
      producing_run_id:
        range: int
        minimum_value: 0
      owner_user_id:
        range: int
        minimum_value: 0
      collection_id:
        range: int
        minimum_value: 0
    # NOTE - the LinkML schema doesn't support a native "plural name" field as far as I can tell, so
    # we're using an annotation here to tack on the extra functionality that we need. We do this because
    # English pluralization is hard, and we don't want to have to write a custom pluralization function.
    # This basically means we now have our own "dialect" of LinkML to worry about. We may want to see if
    # pluralization can be added to the core spec in the future.
    annotations:
      plural: Entities

  File:
    attributes:
      id:
        identifier: true
        range: uuid
      # This file's ID is stored in the entity column <entity_field_name>_id
      entity_field_name:
        range: string
        required: true
      # Which entity this file is connected to
      entity:
        range: Entity
        required: true
      status:
        range: FileStatus
        required: true
      protocol:
        range: FileAccessProtocol
        required: true
      # Bucket name
      namespace:
        range: string
        required: true
      # Prefix (does not start with /)
      path:
        range: string
        required: true
      file_format:
        range: string
        required: true
      compression_type:
        range: string
      size:
        range: int
        minimum_value: 0

  # ============================================================================
  # Entities
  # ============================================================================

  # ----------------------------------------------------------------------------
  # Lab sample, associated with one or more SequencingRead entities.
  # ----------------------------------------------------------------------------
  Sample:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      name:
        range: string
        required: true
      # Metadata provided by user
      sample_type:
        range: string
        required: true
        annotations:
          factory_type: organ
      water_control:
        range: boolean
        required: true
      collection_date:
        range: date
      collection_location:
        range: string
        required: true
        annotations:
          factory_type: city
      description:
        range: string
      host_taxon:
        range: Taxon
        inverse: Taxon.samples
      sequencing_reads:
        range: SequencingRead
        multivalued: true
        inverse: SequencingRead.sample
      metadatas:
        range: Metadatum
        inverse: Metadatum.sample
        multivalued: true
    annotations:
      plural: Samples

  # ----------------------------------------------------------------------------
  # Collection of sequencing reads, stored in FASTQ files.
  # ----------------------------------------------------------------------------
  SequencingRead:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      # Sample associated with this SequencingRead (a sample can have multiple sets of SequencingReads)
      sample:
        range: Sample
        inverse: Sample.sequencing_reads
      # Wet lab protocol
      protocol:
        range: SequencingProtocol
        required: true
      # Files containing sequencing reads (R1 and R2 refer to read pairs 1/2 in Illumina paired-end sequencing)
      r1_file:
        range: File
      r2_file:
        range: File
      # Which sequencing technology / instrument was used?
      technology:
        range: SequencingTechnology
        required: true
      # Did we sequence DNA or RNA?
      nucleic_acid:
        range: NucleicAcid
        required: true
      # Does the sample include ERCCs, synthetic sequences of known quantity used for QC checks
      has_ercc:
        range: boolean
        required: true
      # Can specify a taxon if it's known, e.g. for "Viral Consensus Genome" pipeline (optional)
      taxon:
        range: Taxon
        inverse: Taxon.sequencing_reads
      # Can specify a primer BED file, used to trim primers, e.g. for "Viral Consensus Genome" pipeline (optional)
      primer_file:
        range: GenomicRange
        inverse: GenomicRange.sequencing_reads
      # Consensus Genomes generated from these Sequencing Reads
      consensus_genomes:
        range: ConsensusGenome
        inverse: ConsensusGenome.sequence_read
        multivalued: true
      # Contigs generated from these Sequencing Reads
      contigs:
        range: Contig
        inverse: Contig.sequencing_read
        multivalued: true
    annotations:
      plural: SequencingReads

  # ----------------------------------------------------------------------------
  # Collection of genomic ranges, stored in BED/GTF files.
  # ----------------------------------------------------------------------------
  GenomicRange:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      # Genomic coordinates based this reference genome
      reference_genome:
        range: ReferenceGenome
        inverse: ReferenceGenome.genomic_ranges
        required: true
      file:
        range: File
      sequencing_reads:
        range: SequencingRead
        inverse: SequencingRead.primer_file
        multivalued: true
    annotations:
      plural: GenomicRanges

  # ----------------------------------------------------------------------------
  # Reference genomes / host genomes
  # ----------------------------------------------------------------------------
  ReferenceGenome:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      # FASTA reference genome
      file:
        range: File
      # Indexed FASTA file (.FAI file if any)
      file_index:
        range: File
      # e.g. GRCh38.p14
      name:
        range: string
        required: true
      # e.g. Human (GRCh38)
      description:
        range: string
        required: true
      taxon:
        range: Taxon
        required: true
        inverse: Taxon.reference_genomes
      # Optional metadata: when do viral consensus genome, we try to parse accession ID from the FASTA header.
      accession_id:
        range: string
      sequence_alignment_indices:
        range: SequenceAlignmentIndex
        inverse: SequenceAlignmentIndex.reference_genome
        multivalued: true
      consensus_genomes:
        range: ConsensusGenome
        inverse: ConsensusGenome.reference_genome
        multivalued: true
      genomic_ranges:
        range: GenomicRange
        inverse: GenomicRange.reference_genome
        multivalued: true
      # TODO: Uncomment this when we have support for backgrounds
      # Stores host genome's background that we prepared. We currently have 2 backgrounds (26, 98) assigned to all host genomes.
      # background:
      #   range: Background
    annotations:
      plural: ReferenceGenomes

  # ----------------------------------------------------------------------------
  # Index used by sequence aligners (bowtie, minimap, etc) to represent the
  # reference genome more efficiently for querying.
  # ----------------------------------------------------------------------------
  SequenceAlignmentIndex:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      index_file:
        range: File
      reference_genome:
        range: ReferenceGenome
        required: true
        inverse: ReferenceGenome.sequence_alignment_indices
      tool:
        range: AlignmentTool
        required: true
    annotations:
      plural: SequenceAlignmentIndices

  # ----------------------------------------------------------------------------
  # Metadata
  # ----------------------------------------------------------------------------
  Metadatum:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      sample:
        range: Sample
        inverse: Sample.metadatas
        required: true
      metadata_field:
        range: MetadataField
        required: true
        inverse: MetadataField.metadatas
      value:
        range: string
        required: true
    annotations:
      plural: Metadatas

  MetadataField:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      field_group:
        range: MetadataFieldProject
        inverse: MetadataFieldProject.metadata_field
        multivalued: true
        required: true
      field_name:
        range: string
        required: true
      description:
        range: string
        required: true
      field_type:
        range: string
        required: true
      is_required:
        range: boolean
        required: true
      options:
        range: string
      default_value:
        range: string
      metadatas:
        range: Metadatum
        inverse: Metadatum.metadata_field
        multivalued: true
    annotations:
      plural: MetadataFields

  MetadataFieldProject:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      # TODO: should this be replaced with collection_id?
      project_id:
        range: int
        required: true
      metadata_field:
        range: MetadataField
        inverse: MetadataField.field_group
        required: true
    annotations:
      plural: MetadataFieldProjects

  # ----------------------------------------------------------------------------
  # Result of generating a consensus genome
  # ----------------------------------------------------------------------------
  ConsensusGenome:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      taxon:
        range: Taxon
        required: true
        inverse: Taxon.consensus_genomes
      sequence_read:
        range: SequencingRead
        required: true
        inverse: SequencingRead.consensus_genomes
      reference_genome:
        range: ReferenceGenome
        required: true
        inverse: ReferenceGenome.consensus_genomes
      # Consensus Genome sequence
      sequence:
        range: File
      is_reverse_complement:
        range: boolean
        required: true
      # Zip file containing intermediate outputs
      intermediate_outputs:
        range: File
      metrics:
        range: MetricConsensusGenome
        inverse: MetricConsensusGenome.consensus_genome
        multivalued: true
    annotations:
      plural: ConsensusGenomes

  MetricConsensusGenome:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      consensus_genome:
        range: ConsensusGenome
        required: true
        inverse: ConsensusGenome.metrics
      coverage_depth:
        range: float
      reference_genome_length:
        range: float
      percent_genome_called:
        range: float
      percent_identity:
        range: float
      gc_percent:
        range: float
      total_reads:
        range: int
      mapped_reads:
        range: int
      ref_snps:
        range: int
      n_actg:
        range: int
      n_missing:
        range: int
      n_ambiguous:
        range: int
      coverage_viz_summary_file:
        range: File
    annotations:
      plural: MetricsConsensusGenomes

  # ----------------------------------------------------------------------------
  # Taxon lineage information
  # ----------------------------------------------------------------------------
  Taxon:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      wikipedia_id:
        range: string
      description:
        range: string
      common_name:
        range: string
      name:
        range: string
        required: true
      is_phage:
        range: boolean
        required: true
      upstream_database:
        range: UpstreamDatabase
        required: true
        inverse: UpstreamDatabase.taxa
      upstream_database_identifier:
        range: string
        required: true
      level:
        range: TaxonLevel
        required: true
      tax_id:
        range: int
        required: true
      tax_id_parent:
        range: int
        required: true
      tax_id_species:
        range: int
        required: true
      tax_id_genus:
        range: int
        required: true
      tax_id_family:
        range: int
        required: true
      tax_id_order:
        range: int
        required: true
      tax_id_class:
        range: int
        required: true
      tax_id_phylum:
        range: int
        required: true
      tax_id_kingdom:
        range: int
        required: true
      consensus_genomes:
        range: ConsensusGenome
        inverse: ConsensusGenome.taxon
        multivalued: true
      reference_genomes:
        range: ReferenceGenome
        inverse: ReferenceGenome.taxon
        multivalued: true
      sequencing_reads:
        range: SequencingRead
        inverse: SequencingRead.taxon
        multivalued: true
      samples:
        range: Sample
        inverse: Sample.host_taxon
        multivalued: true
    annotations:
      plural: Taxa

  UpstreamDatabase:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      name:
        range: string
        required: true
      taxa:
        range: Taxon
        multivalued: true
        inverse: Taxon.upstream_database
    annotations:
      plural: UpstreamDatabases

  # ----------------------------------------------------------------------------
  # Contigs generated from SequencingReads
  # ----------------------------------------------------------------------------
  Contig:
    is_a: Entity
    mixins:
      - EntityMixin
    attributes:
      sequencing_read:
        range: SequencingRead
        inverse: Sample.contigs
      sequence:
        required: true
    annotations:
      plural: Contigs

  # ============================================================================
  # Mixins
  # ============================================================================

  EntityMixin:
    mixin: true
    attributes:
      entity_id:
        required: true
        readonly: true
        range: uuid
        identifier: true
        inverse: entity.id
